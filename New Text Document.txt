// ===== Add near top with other let/const =====
let computerMemory = [];          // [{card, img}]
let memoryLimit = 4;
let computerThinkingTimeout = null;
let computerDifficulty = "medium";
let vsComputer = false;

// ----- Configure difficulty helper -----
function configureComputerDifficulty(level){
  computerDifficulty = level;
  if(level === "easy") memoryLimit = 2;
  else if(level === "medium") memoryLimit = 4;
  else if(level === "hard") memoryLimit = 6;
}

// ----- Memory helpers -----
function clearComputerMemory(){
  computerMemory = [];
  if(computerThinkingTimeout){
    clearTimeout(computerThinkingTimeout);
    computerThinkingTimeout = null;
  }
}

function rememberCard(card){
  const img = card.querySelector(".cardBack img").src;
  if(computerMemory.some(e => e.card === card)) return;
  computerMemory.push({card, img});
  if(computerMemory.length > memoryLimit) computerMemory.shift();
}

function purgeMatchedFromMemory(){
  computerMemory = computerMemory.filter(entry => !entry.card.classList.contains("flipped")); 
}

function findKnownPair(){
  purgeMatchedFromMemory();
  for(let i = 0; i < computerMemory.length; i++){
    for(let j = i+1; j < computerMemory.length; j++){
      if(computerMemory[i].img === computerMemory[j].img &&
         !computerMemory[i].card.classList.contains("flipped") &&
         !computerMemory[j].card.classList.contains("flipped")){
          return [computerMemory[i].card, computerMemory[j].card];
      }
    }
  }
  return null;
}

function getRandomUnflippedCard(excludeCard){
  const unflipped = [...cards].filter(c => !c.classList.contains("flipped") && c !== excludeCard);
  if(unflipped.length === 0) return null;
  return unflipped[Math.floor(Math.random() * unflipped.length)];
}

// ----- Programmatic flip used by computer -----
function flipComputerCard(card){
  if(!card || lockBoard || card.classList.contains("flipped")) return;
  flippingSound();
  card.classList.add("flipped");

  if(!card1){
    card1 = card;
  } else if(!card2 && card !== card1){
    card2 = card;
  }

  rememberCard(card);
}

// ----- Computer turn flow -----
function startComputerTurn(){
  turn = true;
  player1Label.classList.remove("redText");
  player2Label.classList.add("redText");
  lockBoard = true;
  const thinkTime = 800 + Math.random() * 1200;
  computerThinkingTimeout = setTimeout(() => {
    computerThinkingTimeout = null;
    computerPlay();
  }, thinkTime);
}

function computerPlay(){
  const forgetChance = (computerDifficulty === "easy") ? 0.35 : (computerDifficulty === "medium") ? 0.18 : 0.08;
  if(Math.random() < forgetChance && computerMemory.length > 0){
    const idx = Math.floor(Math.random() * computerMemory.length);
    computerMemory.splice(idx, 1);
  }

  const knownPair = findKnownPair();

  if(knownPair && Math.random() > 0.08){
    const [cA, cB] = knownPair;
    flipComputerCard(cA);
    setTimeout(() => {
      flipComputerCard(cB);
      setTimeout(() => {
        checkMatch();
        // decide next step after checkMatch (checkMatch changes turn or keeps it)
        if(![...cards].every(card => card.classList.contains("flipped"))){
          if(!turn){
            lockBoard = false;
            player1Label.classList.add("redText");
            player2Label.classList.remove("redText");
          } else {
            const nextDelay = 600 + Math.random() * 900;
            computerThinkingTimeout = setTimeout(computerPlay, nextDelay);
          }
        }
      }, 750);
    }, 700);
  } else {
    const first = getRandomUnflippedCard();
    if(!first){
      lockBoard = false;
      return;
    }
    flipComputerCard(first);
    setTimeout(() => {
      const firstImg = first.querySelector(".cardBack img").src;
      const memoryMatch = computerMemory.find(e => e.img === firstImg && e.card !== first && !e.card.classList.contains("flipped"));
      let second;
      if(memoryMatch && Math.random() > 0.15) second = memoryMatch.card;
      else second = getRandomUnflippedCard(first);

      if(!second){
        lockBoard = false;
        return;
      }
      flipComputerCard(second);

      setTimeout(() => {
        checkMatch();
        if(![...cards].every(card => card.classList.contains("flipped"))){
          if(!turn){
            lockBoard = false;
            player1Label.classList.add("redText");
            player2Label.classList.remove("redText");
          } else {
            const nextDelay = 700 + Math.random() * 900;
            computerThinkingTimeout = setTimeout(computerPlay, nextDelay);
          }
        }
      }, 750);
    }, 700);
  }
}
